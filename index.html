<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Warfarin Dose Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Prompt', sans-serif;
        }
        /* Custom pill styling for visual representation */
        .pill { width: 24px; height: 24px; border-radius: 9999px; display: inline-block; margin: 2px; }
        .pill-2 { background-color: orange; } /* Color for 2mg pill */
        .pill-3 { background-color: skyblue; } /* Color for 3mg pill */
        .pill-5 { background-color: pink; } /* Color for 5mg pill */
        .pill-half-left {
            width: 24px; height: 24px;
            border-radius: 9999px;
            display: inline-block;
            margin: 2px;
            /* Creates a half-circle effect for half pills */
            clip-path: inset(0 50% 0 0);
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-5xl mx-auto bg-white p-6 rounded-2xl shadow-lg relative">
        <div class="absolute top-6 right-6">
            <span class="bg-blue-100 text-blue-700 text-xs font-semibold px-2.5 py-1 rounded-full">Warfarin ‡∏Ñ‡∏¥‡∏î‡πÅ‡∏õ‡πä‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß !</span>
        </div>
        <h1 class="text-2xl font-bold mb-6 text-center text-blue-800 bg-blue-50 p-4 rounded-xl shadow">‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤ Warfarin</h1>
        
        <h2 class="text-lg font-bold mb-4 text-center text-gray-800">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤ Warfarin</h2>
        <div class="max-w-4xl mx-auto mb-6">
            <div style="position: relative; width: 100%; height: 0; padding-top: 56.2500%;
             padding-bottom: 0; box-shadow: 0 2px 8px 0 rgba(63,69,81,0.16); margin-top: 1.6em; margin-bottom: 0.9em; overflow: hidden;
             border-radius: 8px; will-change: transform;">
              <iframe loading="lazy" style="position: absolute; width: 100%; height: 100%; top: 0; left: 0; border: none; padding: 0;margin: 0;"
                src="https://www.canva.com/design/DAGr4hxyiRI/T8PUUZhf8fgNkFF_EU0iPQ/view?embed" allowfullscreen="allowfullscreen" allow="fullscreen">
              </iframe>
            </div>
            <a href="https://www.canva.com/design/DAGr4hxyiRI/T8PUUZhf8fgNkFF_EU0iPQ/view?utm_content=DAGr4hxyiRI&amp;utm_campaign=designshare&amp;utm_medium=embeds&amp;utm_source=link" target="_blank" rel="noopener" class="block text-center text-xs text-gray-500 mt-2 hover:text-blue-600">Design by Narawit Kamyuang</a>
        </div>

        <hr class="my-6 border-gray-300">

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label for="previousDoseInput" class="block text-gray-700 text-sm font-bold mb-2">‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (mg/week)</label>
                <input type="number" id="previousDoseInput" class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" step="0.1" min="0">
            </div>
            <div>
                <label for="weeklyDoseInput" class="block text-gray-700 text-sm font-bold mb-2">‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà (mg/week)</label>
                <input type="number" id="weeklyDoseInput" class="w-full border border-gray-300 px-3 py-2 rounded-lg bg-orange-100 focus:outline-none focus:ring-2 focus:ring-orange-500" step="0.1" min="0">
            </div>
            <div class="flex items-center pt-4 md:pt-0">
                <input type="checkbox" id="allowHalf" checked class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500 accent-orange-500">
                <label for="allowHalf" class="ml-2 text-gray-700 text-sm font-bold">‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ *‡∏Ñ‡∏£‡∏∂‡πà‡∏á* ‡πÄ‡∏°‡πá‡∏î</label>
            </div>
        </div>
        
        <div class="mt-4 mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô)</label>
            <div class="flex flex-col sm:flex-row gap-x-6 gap-y-2">
                <div class="flex items-center">
                    <input type="radio" id="pattern_fri_sun" name="specialDayPattern" value="fri-sun" checked class="form-radio h-4 w-4 text-orange-600 focus:ring-orange-500 accent-orange-500">
                    <label for="pattern_fri_sun" class="ml-2 text-gray-700">‡∏®‡∏∏‡∏Å‡∏£‡πå, ‡πÄ‡∏™‡∏≤‡∏£‡πå, ‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</label>
                </div>
                <div class="flex items-center">
                    <input type="radio" id="pattern_mon_wed_fri" name="specialDayPattern" value="mon-wed-fri" class="form-radio h-4 w-4 text-orange-600 focus:ring-orange-500 accent-orange-500">
                    <label for="pattern_mon_wed_fri" class="ml-2 text-gray-700">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå, ‡∏û‡∏∏‡∏ò, ‡∏®‡∏∏‡∏Å‡∏£‡πå</label>
                </div>
            </div>
        </div>

        <div id="adjustmentTable" class="my-4"></div>
        <div class="flex justify-center">
            <button id="showBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg mb-4 w-full md:w-auto hover:bg-blue-700 transition duration-150 ease-in-out shadow-md">‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        </div>
        <div id="percentageChange" class="text-center text-2xl my-4" aria-live="polite"></div>

        <hr class="my-6 border-gray-300">
        
        <div class="flex items-center justify-center">
            <input type="checkbox" id="appointmentToggle" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500 accent-orange-500">
            <label for="appointmentToggle" class="ml-2 text-gray-800 font-bold">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏¢‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î</label>
        </div>
        <p class="text-center text-xs text-gray-500 mt-1">*‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô 1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</p>
        
        <div id="appointmentFields" class="hidden mt-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="startDate" class="block text-gray-700 text-sm font-bold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤):</label>
                    <input type="date" id="startDate" class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="endDate" class="block text-gray-700 text-sm font-bold mb-2">‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</label>
                    <input type="date" id="endDate" class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div id="daysResult" class="text-center text-lg font-semibold mb-4 text-gray-700" aria-live="polite"></div>
        </div>

        <div id="result" class="space-y-4 mt-6" aria-live="polite"></div>

        <div class="text-right text-xs text-gray-400 mt-6 pt-4 border-t border-gray-200">
            <p>‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏†‡∏Å.‡∏ô‡∏£‡∏≤‡∏ß‡∏¥‡∏ä‡∏ç‡πå ‡∏Ñ‡∏≥‡∏¢‡∏ß‡∏á</p>
            <p>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡∏£‡∏£‡∏° ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∏‡∏ó‡∏±‡∏¢</p>
        </div>
    </div>

    <script>
        const pills = [5, 3, 2]; // Pill strengths available (mg)
        const daysName = ['‡∏à.', '‡∏≠.', '‡∏û.', '‡∏û‡∏§.', '‡∏®.', '‡∏™.', '‡∏≠‡∏≤.']; // Thai abbreviations for days of the week
        const DOSE_MULTIPLIER_LIMIT = 2.5; // Special dose not exceed 2.5 times normal dose
        const ABSOLUTE_MAX_DAILY_DOSE = 15; // Absolute maximum daily dose in mg
        const FLOAT_TOLERANCE = 0.01; // Tolerance for floating point comparisons to avoid precision issues

        /**
         * Generates and displays interactive buttons for dose adjustment based on the previous dose.
         * These buttons allow users to quickly select a new weekly dose as a percentage change.
         */
        function generateDoseAdjustmentTable() {
            const prev = parseFloat(document.getElementById('previousDoseInput').value);
            const adjustmentTableDiv = document.getElementById('adjustmentTable');

            // Clear the table if previous dose is invalid or not entered
            if (isNaN(prev) || prev <= 0) {
                adjustmentTableDiv.innerHTML = '';
                return;
            }
            
            adjustmentTableDiv.innerHTML = '<h3 class="text-lg font-semibold mb-3 text-center text-gray-700">‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ <span class="text-sm font-normal">üñ±Ô∏è (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)</span></h3>';

            // Define percentage changes to suggest
            const percentages = [-20, -15, -10, -5, 0, 5, 10, 15, 20];
            let buttonsHtml = '<div class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-9 gap-2 text-center">';

            percentages.forEach(p => {
                const exactDose = prev * (1 + p / 100);
                // Round to nearest 0.5 mg for practical dosing
                const roundedDose = Math.round(exactDose * 2) / 2;
                // Determine button color based on percentage change
                const buttonColor = p < 0 ? 'bg-red-100 hover:bg-red-200 text-red-800' : (p === 0 ? 'bg-blue-100 hover:bg-blue-200 text-blue-800' : 'bg-green-100 hover:bg-green-200 text-green-800');

                buttonsHtml += `
                    <button 
                        onclick="setWeeklyDoseAndSuggest(${roundedDose})" 
                        class="p-2 rounded-lg ${buttonColor} transition duration-150 ease-in-out shadow-sm border border-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <div class="font-bold text-lg">${p > 0 ? '+' : ''}${p}%</div>
                        <div class="text-sm">${roundedDose.toFixed(1)} mg</div>
                    </button>
                `;
            });
            buttonsHtml += '</div>';
            adjustmentTableDiv.innerHTML += buttonsHtml;
        }

        /**
         * Sets the weekly dose input field with the provided dose and then triggers
         * the display of percentage change and generation of dose suggestions.
         * @param {number} dose - The weekly dose to set.
         */
        function setWeeklyDoseAndSuggest(dose) {
            document.getElementById('weeklyDoseInput').value = dose.toFixed(1);
            displayPercentageChange(); // Update percentage change display
            generateSuggestions(); // Generate new dose suggestions
        }
        
        /**
         * Calculates and displays the percentage change between the previous and new weekly doses.
         * Provides visual feedback (arrow and color) for increase, decrease, or no change.
         */
        function displayPercentageChange() {
            const weeklyDose = parseFloat(document.getElementById('weeklyDoseInput').value);
            const previousDose = parseFloat(document.getElementById('previousDoseInput').value);
            const percentageChangeDiv = document.getElementById('percentageChange');
            
            percentageChangeDiv.innerHTML = ''; // Clear previous display
            
            if (!isNaN(weeklyDose) && !isNaN(previousDose) && previousDose > 0) {
                const pctChange = ((weeklyDose - previousDose) / previousDose * 100).toFixed(1);
                const arrow = pctChange > 0 ? '‚ñ≤' : (pctChange < 0 ? '‚ñº' : '');
                const color = pctChange > 0 ? 'text-green-600' : (pctChange < 0 ? 'text-red-600' : 'text-gray-800');
                percentageChangeDiv.innerHTML = `<div class="mb-2 text-gray-700">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤</div>
                                 <span class="${color} text-2xl font-bold">${arrow}</span>
                                 <span class="text-gray-800">${Math.abs(pctChange)}%</span>`;
            }
        }

        /**
         * Generates and displays suggestions for Warfarin dosage based on the target weekly dose,
         * allowing for uniform daily doses or non-uniform doses with special days.
         * It prioritizes options that are simpler (fewer pill types, fewer half pills).
         */
        function generateSuggestions() {
            const weeklyDose = parseFloat(document.getElementById('weeklyDoseInput').value);
            const allowHalf = document.getElementById('allowHalf').checked;
            const specialDayPattern = document.querySelector('input[name="specialDayPattern"]:checked').value;
            const resultDiv = document.getElementById('result');

            resultDiv.innerHTML = ''; // Clear previous results

            // Validate input
            if (isNaN(weeklyDose) || weeklyDose < 0) {
                resultDiv.innerHTML = '<div class="text-red-600 text-center font-bold">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>';
                return;
            }

            displayPercentageChange(); // Ensure percentage change is updated

            let daysUntilAppointment = 7; // Default to 7 days for weekly calculation
            let isAppointmentCalculation = false;
            const appointmentToggle = document.getElementById('appointmentToggle').checked;

            // If appointment calculation is enabled, get the number of days between appointments
            if (appointmentToggle) {
                const { daysDiff, isValid } = getAppointmentDays();
                if (isValid) {
                    daysUntilAppointment = daysDiff;
                    isAppointmentCalculation = true;
                } else {
                    // If dates are invalid, display an error and return
                    resultDiv.innerHTML = '<div class="text-red-600 text-center font-bold">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>';
                    return;
                }
            }

            let options = []; // Stores all valid dose combinations
            const seenOptions = new Set(); // Used to prevent duplicate options

            if (weeklyDose === 0) {
                // Special case for zero dose (stop medication)
                options.push({
                    type: 'zero-dose',
                    comboWeekly: Array(7).fill([]), // Represent as 0mg for all days
                    weeklyDoseActual: 0,
                    priority: -1 // Highest priority
                });
            } else {
                // --- Generate Uniform Daily Dose options ---
                // Calculate a reasonable max daily dose to search up to, considering the weekly dose
                const maxDailyDoseForCalc = Math.max(ABSOLUTE_MAX_DAILY_DOSE, weeklyDose / 7 * 1.5);
                for (let dailyDose = 0.5; dailyDose <= maxDailyDoseForCalc + FLOAT_TOLERANCE; dailyDose += 0.5) {
                    // Find pill combinations for the current daily dose
                    const dailyCombos = findComb(dailyDose, pills, allowHalf, 1, 4); // Max 4 pill objects per day
                    if (dailyCombos.length > 0) {
                        dailyCombos.forEach(c => {
                            // Calculate the actual weekly dose from this daily combo
                            const actualWeeklyDose = c.reduce((sum, p) => sum + (p.half ? p.mg * 0.5 : p.mg * p.count), 0) * 7;
                            // Check if the actual weekly dose is very close to the target weekly dose
                            if (Math.abs(actualWeeklyDose - weeklyDose) < FLOAT_TOLERANCE) {
                                // Create a unique key for the combination to avoid duplicates
                                const key = `uniform-${JSON.stringify(c.map(p => `${p.mg}-${p.count}-${p.half}`).sort())}`;
                                if (!seenOptions.has(key)) {
                                    seenOptions.add(key);
                                    options.push({ type: 'uniform', combo: c, weeklyDoseActual: actualWeeklyDose, priority: 0 });
                                }
                            }
                        });
                    }
                }

                // --- Generate Non-uniform Dose options ---
                // Try different numbers of "special" days (days with a different dose)
                for (let numSpecialDays = 1; numSpecialDays <= 3; numSpecialDays++) {
                    const normalDaysCount = 7 - numSpecialDays;
                    if (normalDaysCount < 1) continue; // Must have at least one normal day

                    // Get the indices of the special days based on the selected pattern
                    const specialDaysIndices = getSpecialDaysIndices(numSpecialDays, specialDayPattern);
                    if (specialDaysIndices.length !== numSpecialDays) continue; // Ensure pattern provides enough days

                    // Iterate through possible base doses for normal days
                    for (let baseDose = 0.5; baseDose <= ABSOLUTE_MAX_DAILY_DOSE + FLOAT_TOLERANCE; baseDose += 0.5) {
                        const normalDayCombos = findComb(baseDose, pills, allowHalf, 1, 4);
                        if (normalDayCombos.length === 0) continue; // No valid combo for normal day dose

                        // Calculate remaining dose needed for special days
                        const remainingDoseForSpecialDays = weeklyDose - (baseDose * normalDaysCount);
                        if (remainingDoseForSpecialDays < -FLOAT_TOLERANCE) continue; // Cannot have negative remaining dose

                        // Calculate the target dose for each special day
                        const specialDayDoseTarget = +(remainingDoseForSpecialDays / numSpecialDays).toFixed(2);

                        // Check constraints for special day dose: within max, and not too close to base dose unless it's zero
                        const specialDoseConstraintMet = (specialDayDoseTarget >= -FLOAT_TOLERANCE && specialDayDoseTarget <= ABSOLUTE_MAX_DAILY_DOSE + FLOAT_TOLERANCE) && 
                                                         (Math.abs(specialDayDoseTarget) < FLOAT_TOLERANCE || // Allow 0mg for special day
                                                         (Math.abs(specialDayDoseTarget - baseDose) > FLOAT_TOLERANCE && // Special dose must be different from base dose
                                                          specialDayDoseTarget <= baseDose * DOSE_MULTIPLIER_LIMIT + FLOAT_TOLERANCE)); // Special dose within multiplier limit

                        if (!specialDoseConstraintMet) continue;

                        // Find pill combinations for the special day dose
                        const specialDayCombos = findComb(specialDayDoseTarget, pills, allowHalf, specialDayDoseTarget === 0 ? 0 : 1, 4);
                        if (specialDayCombos.length === 0) continue; // No valid combo for special day dose

                        // Combine normal and special day combos to form a weekly plan
                        specialDayCombos.forEach(sCombo => {
                            normalDayCombos.forEach(nCombo => {
                                const comboWeekly = Array(7).fill(null);
                                for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                                    comboWeekly[dayIdx] = specialDaysIndices.includes(dayIdx) ? sCombo.slice() : nCombo.slice();
                                }

                                // Calculate the actual total weekly dose for this combination
                                let currentWeeklyDoseSum = comboWeekly.reduce((sum, dayCombo) => sum + (dayCombo ? dayCombo.reduce((dSum, p) => dSum + (p.half ? p.mg * 0.5 : p.mg * p.count), 0) : 0), 0);
                                
                                // If the actual weekly dose matches the target
                                if (Math.abs(currentWeeklyDoseSum - weeklyDose) < FLOAT_TOLERANCE) {
                                    // Create a unique key for the non-uniform combination
                                    const key = `nonuniform-${JSON.stringify(comboWeekly.map(day => day ? day.map(p => `${p.mg}-${p.count}-${p.half}`).sort().join('|') : 'null'))}`;
                                    if (!seenOptions.has(key)) {
                                        seenOptions.add(key);
                                        options.push({ type: 'non-uniform', comboWeekly: comboWeekly, specialDays: specialDaysIndices, baseDose: baseDose, specialDose: specialDayDoseTarget, weeklyDoseActual: currentWeeklyDoseSum, priority: 1 });
                                    }
                                }
                            });
                        });
                    }
                }
            }

            // Sort options based on priority (uniform first), then number of pill colors, total pill objects, and number of half pills
            options.sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                const aColors = countPillColors(a);
                const bColors = countPillColors(b);
                if (aColors !== bColors) return aColors - bColors;
                const aTotalPills = countTotalPillObjects(a);
                const bTotalPills = countTotalPillObjects(b);
                if (aTotalPills !== bTotalPills) return aTotalPills - bTotalPills;
                return countHalves(a) - countHalves(b);
            });

            // Display a message if no suitable options are found
            if (options.length === 0) {
                resultDiv.innerHTML = '<div class="text-red-600 text-center font-bold">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>';
                return;
            }

            // Render the top 30 suggestions
            options.slice(0, 30).forEach((option, index) => {
                let optionHtml = `<div class="border border-gray-200 p-4 rounded-lg bg-gray-50 mb-4 shadow-sm">
                                <div class="font-semibold text-blue-700 mb-2">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${index+1}: `;
                let weeklyDoseActual = option.weeklyDoseActual || 0;

                // Generate description based on option type
                if (option.type === 'zero-dose') {
                    optionHtml += `‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ (‡∏£‡∏ß‡∏° 0 mg/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)`;
                } else if (option.type === 'uniform') {
                    const dailyDose = option.combo.reduce((sum, p) => sum + (p.half ? p.mg * 0.5 : p.mg * p.count), 0);
                    optionHtml += `‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏ß‡∏±‡∏ô‡∏•‡∏∞ ${dailyDose.toFixed(1)} mg`;
                } else if (option.type === 'non-uniform') {
                    // Filter special days into zero-dose and non-zero-dose categories
                    const zeroDoseSpecialDays = (option.specialDays || []).filter(idx => Math.abs(option.comboWeekly[idx].reduce((sum, p) => sum + (p.half ? p.mg * 0.5 : p.mg * p.count), 0)) < FLOAT_TOLERANCE);
                    const nonZeroSpecialDays = (option.specialDays || []).filter(idx => Math.abs(option.comboWeekly[idx].reduce((sum, p) => sum + (p.half ? p.mg * 0.5 : p.mg * p.count), 0)) >= FLOAT_TOLERANCE);
                    
                    let specialDoseDescription = '';
                    if (nonZeroSpecialDays.length > 0) {
                        specialDoseDescription += `‡∏Ç‡∏ô‡∏≤‡∏î‡∏¢‡∏≤‡∏ß‡∏±‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ${option.specialDose.toFixed(1)} mg (${nonZeroSpecialDays.map(idx => daysName[idx]).join(', ')})`;
                    }
                    if (zeroDoseSpecialDays.length > 0) {
                        specialDoseDescription += `${specialDoseDescription ? ', ' : ''}‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤ (${zeroDoseSpecialDays.map(idx => daysName[idx]).join(', ')})`;
                    }
                    optionHtml += `‡∏ß‡∏±‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ ${option.baseDose.toFixed(1)} mg, ${specialDoseDescription}`;
                }
                optionHtml += ` (‡∏£‡∏ß‡∏° ${weeklyDoseActual.toFixed(1)} mg/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)</div>`;

                // Display daily pill breakdown
                optionHtml += `<div class="grid grid-cols-7 gap-2 mt-4">`;
                for (let j = 0; j < 7; j++) {
                    // Pass the specialDaysIndices to renderDay to apply different background
                    const isSpecialDay = option.type === 'non-uniform' && option.specialDays.includes(j);
                    const combo = option.comboWeekly ? option.comboWeekly[j] : (option.combo || []);
                    optionHtml += renderDay(j, combo, isSpecialDay);
                }
                optionHtml += `</div>`;

                // Display total pills needed for the period (weekly or appointment)
                let totalPillsHeader = isAppointmentCalculation ? `‡∏£‡∏ß‡∏°‡∏¢‡∏≤‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î (${daysUntilAppointment} ‡∏ß‡∏±‡∏ô):` : '‡∏£‡∏ß‡∏°‡∏¢‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 1 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå:';
                optionHtml += `<div class="mt-4 text-sm border-t border-gray-200 pt-2 text-gray-700">
                                 <span class="font-bold">${totalPillsHeader}</span><br>`;
                
                let pillsNeededMessage = '';
                if (option.type === 'zero-dose') {
                    pillsNeededMessage = '<span>‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤</span>';
                } else {
                    let halfPillCounts = { 2: 0, 3: 0, 5: 0 }; // Counts for half pills (e.g., 1 half of 5mg)
                    let wholePillCounts = { 2: 0, 3: 0, 5: 0 }; // Counts for whole pills (e.g., 1 whole 5mg)

                    // Aggregate pill counts over the entire period (daysUntilAppointment)
                    for (let day = 0; day < daysUntilAppointment; day++) {
                        const currentDayIndex = day % 7; // Cycle through the 7-day pattern
                        const comboForDay = option.comboWeekly ? option.comboWeekly[currentDayIndex] : option.combo;
                        if (comboForDay) {
                            comboForDay.forEach(p => {
                                if (p.half) halfPillCounts[p.mg]++;
                                else wholePillCounts[p.mg] += p.count; // Corrected variable name here
                            });
                        }
                    }

                    // Calculate total pills to dispense for each strength
                    [5, 3, 2].forEach(mg => {
                        const wholePills = wholePillCounts[mg] + Math.floor(halfPillCounts[mg] / 2); // Combine whole pills and pairs of halves
                        const remainingHalves = halfPillCounts[mg] % 2; // Any remaining single halves
                        const actualUsed = wholePills + remainingHalves * 0.5; // Total actual dose in terms of pills
                        const dispensedPills = wholePills + remainingHalves; // Total physical pills to dispense

                        if (dispensedPills > 0) {
                            pillsNeededMessage += `<span class="pill pill-${mg}"></span> ${mg}mg: ${dispensedPills} ‡πÄ‡∏°‡πá‡∏î`;
                            if (remainingHalves > 0) {
                                pillsNeededMessage += ` (‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á ${actualUsed.toFixed(1)} ‡πÄ‡∏°‡πá‡∏î)`;
                            }
                            pillsNeededMessage += `<br>`;
                        }
                    });
                }

                if (pillsNeededMessage === '') pillsNeededMessage = '<span>‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤</span>';
                optionHtml += pillsNeededMessage;
                optionHtml += `</div></div>`;
                resultDiv.innerHTML += optionHtml;
            });
        }

        /**
         * Renders the HTML for a single day's dosage, including visual pill representations
         * and text descriptions.
         * @param {number} idx - The index of the day (0 for Monday, 6 for Sunday).
         * @param {Array<Object>} combo - An array of pill objects for that day.
         * @param {boolean} isSpecialDay - True if this day is a "special dose day".
         * @returns {string} HTML string for the day's display.
         */
        function renderDay(idx, combo, isSpecialDay = false) {
            // Colors for each day of the week for visual distinction
            const dayColors = ['bg-yellow-100', 'bg-rose-100', 'bg-green-100', 'bg-orange-200', 'bg-sky-100', 'bg-purple-100', 'bg-red-100'];
            let visualPills = ''; // HTML for pill icons
            let textPillsArr = []; // Array for text descriptions of pills
            let dayDose = 0; // Total dose for the day
            let containerBaseClasses = "rounded-lg border text-center flex flex-col h-full overflow-hidden"; // Removed default border-gray-300 and bg-white/bg-gray-100 here

            // Calculate dayDose first
            if (combo && combo.length > 0) {
                combo.forEach(p => {
                    dayDose += p.half ? p.mg * 0.5 : p.mg * p.count;
                    if (p.half) {
                        visualPills += `<span class="pill pill-${p.mg} pill-half-left"></span>`;
                        textPillsArr.push(`${p.mg} mg x(‡∏Ñ‡∏£‡∏∂‡πà‡∏á)`);
                    } else {
                        for (let k = 0; k < p.count; k++) {
                            visualPills += `<span class="pill pill-${p.mg}"></span>`;
                        }
                        if (p.count > 0) {
                            textPillsArr.push(`${p.mg} mg x${p.count}`);
                        }
                    }
                });
            }

            const textPillsHtml = textPillsArr.map(t => `<div class="text-xs text-gray-600">${t}</div>`).join('');

            // Determine background and border classes based on dose and special day status
            let backgroundClass = '';
            let borderClass = 'border-gray-300'; // Default border

            if (Math.abs(dayDose) < FLOAT_TOLERANCE) { // No dose for the day
                backgroundClass = 'bg-gray-100';
            } else if (isSpecialDay) { // Special day with a dose
                backgroundClass = 'bg-white'; // Keep background white
                borderClass = 'border-red-300 border-2'; // Add light blue border and make it slightly thicker
            } else { // Normal day with a dose
                backgroundClass = 'bg-white';
            }

            return `<div class="${containerBaseClasses} ${backgroundClass} ${borderClass}">
                        <div class="font-bold text-gray-800 py-1 ${dayColors[idx]}">${daysName[idx]}</div>
                        <div class="p-2 flex-grow flex flex-col">
                            <div class="text-sm text-gray-500">(${dayDose.toFixed(1)} mg)</div>
                            <div class="flex-grow flex flex-col justify-center items-center my-2 min-h-[30px]">
                                <div class="flex justify-center items-center flex-wrap">${visualPills}</div>
                            </div>
                            <div>${textPillsHtml}</div>
                        </div>
                    </div>`;
        }

        /**
         * Finds combinations of available pills (whole and half) that sum up to a target dose.
         * @param {number} target - The target dose in mg.
         * @param {Array<number>} availablePills - An array of available pill strengths (e.g., [5, 3, 2]).
         * @param {boolean} allowHalf - Whether half pills are allowed.
         * @param {number} minPillObjects - Minimum number of pill objects (whole or half) in a combination.
         * @param {number} maxPillObjects - Maximum number of pill objects in a combination.
         * @returns {Array<Array<Object>>} An array of valid pill combinations. Each combination is an array
         * of objects like { mg: strength, count: number, half: boolean }.
         */
        function findComb(target, availablePills, allowHalf, minPillObjects, maxPillObjects) {
            const resultCombos = [];
            const seenCombinations = new Set(); // To avoid duplicate combinations

            // Handle zero target dose
            if (Math.abs(target) < FLOAT_TOLERANCE) {
                if (minPillObjects === 0) return [[]]; // If 0 pills are allowed for 0mg dose
                return []; // Otherwise, no combination for 0mg if minPillObjects > 0
            }
            
            // Iterate through combinations of 5mg, 3mg, and 2mg pills
            // Max loop iterations are capped by maxPillObjects to limit search space
            for (let c5 = 0; c5 <= maxPillObjects; c5++) {
                for (let c3 = 0; c3 <= maxPillObjects - c5; c3++) {
                    for (let c2 = 0; c2 <= maxPillObjects - c5 - c3; c2++) {
                        let currentDose = c5 * 5 + c3 * 3 + c2 * 2;
                        let currentObjects = c5 + c3 + c2;

                        // Check for exact match with whole pills
                        if (Math.abs(currentDose - target) < FLOAT_TOLERANCE && currentObjects >= minPillObjects && currentObjects <= maxPillObjects) {
                            let combo = [];
                            if (c5 > 0) combo.push({ mg: 5, count: c5, half: false });
                            if (c3 > 0) combo.push({ mg: 3, count: c3, half: false });
                            if (c2 > 0) combo.push({ mg: 2, count: c2, half: false });
                            // Sort and stringify to create a unique key for the set
                            const key = JSON.stringify(combo.sort((a, b) => b.mg - a.mg));
                            if (!seenCombinations.has(key)) {
                                seenCombinations.add(key);
                                resultCombos.push(combo);
                            }
                        }

                        // Check for combinations involving one half pill
                        if (allowHalf && currentObjects < maxPillObjects) {
                            for (const pillToHalf of availablePills) {
                                if (Math.abs(currentDose + pillToHalf * 0.5 - target) < FLOAT_TOLERANCE) {
                                    let comboWithHalf = [];
                                    if (c5 > 0) comboWithHalf.push({ mg: 5, count: c5, half: false });
                                    if (c3 > 0) comboWithHalf.push({ mg: 3, count: c3, half: false });
                                    if (c2 > 0) comboWithHalf.push({ mg: 2, count: c2, half: false });
                                    comboWithHalf.push({ mg: pillToHalf, count: 1, half: true }); // Add the half pill
                                    const totalObjects = comboWithHalf.reduce((s, p) => s + p.count, 0);
                                    if (totalObjects >= minPillObjects && totalObjects <= maxPillObjects) {
                                        // Sort by mg then by half status for consistent key generation
                                        const key = JSON.stringify(comboWithHalf.sort((a, b) => b.mg - a.mg || (a.half ? 1 : 0) - (b.half ? 1 : 0)));
                                        if (!seenCombinations.has(key)) {
                                            seenCombinations.add(key);
                                            resultCombos.push(comboWithHalf);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            // Sort results primarily by total number of pill objects, then by number of half pills
            return resultCombos.sort((a, b) => a.reduce((s, p) => s + p.count, 0) - b.reduce((s, p) => s + p.count, 0) || a.filter(p => p.half).length - b.filter(p => p.half).length);
        }

        /**
         * Counts the total number of half pills in a given option.
         * @param {Object} o - The option object (uniform or non-uniform).
         * @returns {number} The total count of half pills.
         */
        function countHalves(o) {
            if (!o.combo && !o.comboWeekly) return 0;
            const combosToScan = o.type === 'uniform' ? [o.combo] : (o.comboWeekly || []);
            let halves = combosToScan.reduce((sum, day) => sum + (day ? day.filter(p => p.half).length : 0), 0);
            return o.type === 'uniform' ? halves * 7 : halves; // Multiply by 7 for uniform dose
        }

        /**
         * Counts the number of distinct pill strengths (colors) used in an option.
         * @param {Object} o - The option object.
         * @returns {number} The number of distinct pill strengths.
         */
        function countPillColors(o) {
            if (!o.combo && !o.comboWeekly) return 0;
            const colors = new Set();
            const combosToScan = o.type === 'uniform' ? [o.combo] : (o.comboWeekly || []);
            combosToScan.forEach(day => day && day.forEach(p => (p.count > 0 || p.half) && colors.add(p.mg)));
            return colors.size;
        }
        
        /**
         * Counts the total number of physical pill objects (whole or half) in an option.
         * @param {Object} o - The option object.
         * @returns {number} The total count of pill objects.
         */
        function countTotalPillObjects(o) {
            if (!o.combo && !o.comboWeekly) return 0;
            const dailyPillObjects = (day) => day ? day.reduce((s, p) => s + (p.half ? 1 : p.count), 0) : 0;
            if (o.type === 'uniform') return dailyPillObjects(o.combo) * 7;
            return (o.comboWeekly || []).reduce((s, day) => s + dailyPillObjects(day), 0);
        }

        /**
         * Returns an array of day indices (0-6) for special dose days based on the pattern.
         * @param {number} numSpecialDays - The number of special days (1, 2, or 3).
         * @param {string} pattern - The pattern ('fri-sun' or 'mon-wed-fri').
         * @returns {Array<number>} An array of day indices.
         */
        function getSpecialDaysIndices(numSpecialDays, pattern = 'fri-sun') {
            // Monday = 0, ..., Sunday = 6
            if (pattern === 'fri-sun') {
                switch (numSpecialDays) {
                    case 1: return [6]; // Sunday
                    case 2: return [5, 6]; // Saturday, Sunday
                    case 3: return [4, 5, 6]; // Friday, Saturday, Sunday
                    default: return [];
                }
            } else if (pattern === 'mon-wed-fri') {
                switch (numSpecialDays) {
                    case 1: return [4]; // Friday
                    case 2: return [2, 4]; // Wednesday, Friday
                    case 3: return [0, 2, 4]; // Monday, Wednesday, Friday
                    default: return [];
                }
            }
            return [];
        }

        /**
         * Calculates the number of days between the start and end appointment dates.
         * @returns {{daysDiff: number, isValid: boolean}} An object containing the difference in days and a validity flag.
         */
        function getAppointmentDays() {
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;
            
            if (!startDateInput || !endDateInput) {
                return { daysDiff: 0, isValid: false };
            }

            const startDate = new Date(startDateInput);
            const endDate = new Date(endDateInput);
            startDate.setHours(0, 0, 0, 0); // Normalize dates to start of day
            endDate.setHours(0, 0, 0, 0);

            const timeDiff = endDate.getTime() - startDate.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24)); // Calculate difference in days

            if (daysDiff < 0) {
                return { daysDiff: 0, isValid: false }; // End date cannot be before start date
            } else {
                return { daysDiff: daysDiff, isValid: true };
            }
        }
        
        /**
         * Updates the display showing the number of days for appointment calculation.
         */
        function updateAppointmentDaysDisplay() {
            const daysResultDiv = document.getElementById('daysResult');
            const { daysDiff, isValid } = getAppointmentDays();

            if (isValid) {
                daysResultDiv.textContent = `‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${daysDiff} ‡∏ß‡∏±‡∏ô`;
            } else {
                const startDateInput = document.getElementById('startDate').value;
                const endDateInput = document.getElementById('endDate').value;
                // Only show error if both dates are entered but invalid
                if(startDateInput && endDateInput) {
                    daysResultDiv.textContent = '‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏î‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô';
                } else {
                    daysResultDiv.textContent = ''; // Clear if dates are not fully entered
                }
            }
        }

        // --- Event Listeners and Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            const appointmentToggle = document.getElementById('appointmentToggle');
            const appointmentFields = document.getElementById('appointmentFields');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const weeklyDoseInput = document.getElementById('weeklyDoseInput');
            const previousDoseInput = document.getElementById('previousDoseInput');
            const showBtn = document.getElementById('showBtn');
            const allowHalf = document.getElementById('allowHalf');
            const specialDayPatternRadios = document.querySelectorAll('input[name="specialDayPattern"]');

            // Event listener for previous dose input to generate adjustment table and percentage change
            previousDoseInput.addEventListener('input', () => {
                generateDoseAdjustmentTable();
                displayPercentageChange();
            });

            // Event listener for weekly dose input to update percentage change
            weeklyDoseInput.addEventListener('input', displayPercentageChange);

            // Event listener for the "Show Options" button
            showBtn.addEventListener('click', generateSuggestions);

            // Event listener for "Allow Half Pill" checkbox
            allowHalf.addEventListener('change', generateSuggestions);

            // Event listeners for special day pattern radio buttons
            specialDayPatternRadios.forEach(radio => {
                radio.addEventListener('change', generateSuggestions);
            });

            // Event listener for appointment toggle
            appointmentToggle.addEventListener('change', () => {
                if (appointmentToggle.checked) {
                    appointmentFields.classList.remove('hidden');
                    // Set default dates if not already set
                    if (!startDateInput.value) {
                        const today = new Date();
                        startDateInput.valueAsDate = today;
                    }
                    if (!endDateInput.value) {
                        const nextWeek = new Date();
                        nextWeek.setDate(nextWeek.getDate() + 7);
                        endDateInput.valueAsDate = nextWeek;
                    }
                    updateAppointmentDaysDisplay(); // Update display immediately
                } else {
                    appointmentFields.classList.add('hidden');
                    document.getElementById('daysResult').textContent = ''; // Clear display
                }
                generateSuggestions(); // Recalculate suggestions based on toggle state
            });

            // Event listeners for start and end date inputs
            startDateInput.addEventListener('change', () => {
                updateAppointmentDaysDisplay();
                generateSuggestions();
            });
            endDateInput.addEventListener('change', () => {
                updateAppointmentDaysDisplay();
                generateSuggestions();
            });

            // Initial calls to set up the UI on page load
            generateDoseAdjustmentTable(); // Generate initial adjustment table if previous dose is present
            displayPercentageChange(); // Display initial percentage change
        });
    </script>
</body>
</html>
